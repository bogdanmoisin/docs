<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://www.elcodi.io/book/coupon-architecture/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>Coupon architecture - Elcodi Documentation</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <link href="../../css/elcodi.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../.."><img src="../../img/elcodi.png" height="30" /></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                
                
                
                    
                        <li >
                            <a href="../../quick-start/">Quick start</a>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown active">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Book <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../cart-architecture/">Cart architecture</a>
</li>

                            
                                
<li >
    <a href="../category-architecture/">Category architecture</a>
</li>

                            
                                
<li >
    <a href="../commands/">Commands</a>
</li>

                            
                                
<li class="active">
    <a href="./">Coupon architecture</a>
</li>

                            
                                
<li >
    <a href="../dictionary/">Dictionary</a>
</li>

                            
                                
<li >
    <a href="../emails/">Emails</a>
</li>

                            
                                
<li >
    <a href="../events/">Events</a>
</li>

                            
                                
<li >
    <a href="../features/">Features</a>
</li>

                            
                                
<li >
    <a href="../">Home</a>
</li>

                            
                                
<li >
    <a href="../payments/">Payments</a>
</li>

                            
                                
<li >
    <a href="../philosophy/">Philosophy</a>
</li>

                            
                                
<li >
    <a href="../plugins/">Plugins</a>
</li>

                            
                                
<li >
    <a href="../processes/">Processes</a>
</li>

                            
                                
<li >
    <a href="../product-architecture/">Product architecture</a>
</li>

                            
                                
<li >
    <a href="../pull-requests/">Pull requests</a>
</li>

                            
                                
<li >
    <a href="../roadmap/">Roadmap</a>
</li>

                            
                                
<li >
    <a href="../running-test-suite/">Running test suite</a>
</li>

                            
                                
<li >
    <a href="../shipping/">Shipping</a>
</li>

                            
                                
<li >
    <a href="../standards/">Standards</a>
</li>

                            
                                
<li >
    <a href="../templates/">Templates</a>
</li>

                            
                                
<li >
    <a href="../translate-elcodi/">Translate elcodi</a>
</li>

                            
                                
<li >
    <a href="../vagrant-quick-start/">Vagrant quick start</a>
</li>

                            
                                
<li >
    <a href="../what-is-elcodi/">What is elcodi</a>
</li>

                            
                                
<li >
    <a href="../why-elcodi/">Why elcodi</a>
</li>

                            
                            </ul>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../cookbook/">Home</a>
</li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Installation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/installation/install-a-plugin/">Install a plugin</a>
</li>

        
            
<li >
    <a href="../../cookbook/installation/install-dependent-bundles/">Install dependent bundles</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Overwrite</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-a-parameter/">Overwrite a parameter</a>
</li>

        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-a-service/">Overwrite a service</a>
</li>

        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-an-entity/">Overwrite an entity</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Deprecation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/deprecation/deprecate-a-method/">Deprecate a method</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Adapters</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/adapters/currency-rates-populator/">Currency rates populator</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/image-resize/">Image resize</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/location-loader/">Location loader</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/location-populator/">Location populator</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/location-provider/">Location provider</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/metric-bucket/">Metric bucket</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/related-purchasables-provider/">Related purchasables provider</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Workflow</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/workflow/create-automatic-coupon/">Create automatic coupon</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Usage</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/usage/elcodi-watermark/">Elcodi watermark</a>
</li>

        
            
<li >
    <a href="../../cookbook/usage/referrer-domain/">Referrer domain</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Implementation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/implementation/implement-a-collector/">Implement a collector</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-controller-and-a-command/">Implement a controller and a command</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-factory/">Implement a factory</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-form-type/">Implement a form type</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-repository/">Implement a repository</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-an-entity/">Implement an entity</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-an-event-listener/">Implement an event listener</a>
</li>

        
    </ul>
  </li>

                            
                            </ul>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Component <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../component/entity-translator/">Entity translator</a>
</li>

                            
                                
<li >
    <a href="../../component/">Home</a>
</li>

                            
                                
<li >
    <a href="../../component/media/">Media</a>
</li>

                            
                                
<li >
    <a href="../../component/menu/">Menu</a>
</li>

                            
                                
<li >
    <a href="../../component/metrics/">Metrics</a>
</li>

                            
                                
<li >
    <a href="../../component/sitemap/">Sitemap</a>
</li>

                            
                                
<li >
    <a href="../../component/state-transition-machine/">State transition machine</a>
</li>

                            
                                
<li >
    <a href="../../component/template/">Template</a>
</li>

                            
                            </ul>
                        </li>
                    
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../commands/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../dictionary/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/elcodi/docs">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#coupon-architecture">Coupon Architecture</a></li>
        
            <li><a href="#create-coupon">Create coupon</a></li>
        
            <li><a href="#coupon-types">Coupon types</a></li>
        
            <li><a href="#coupon-enforcement">Coupon enforcement</a></li>
        
            <li><a href="#minimum-purchase">Minimum purchase</a></li>
        
            <li><a href="#adding-some-rules">Adding some Rules</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="coupon-architecture">Coupon Architecture<a class="headerlink" href="#coupon-architecture" title="Permanent link"> #</a></h1>
<p>Our coupon architecture is intended to work as a simple coupon server. All the
coupon model is decoupled from every other package, so you should be able to
work with coupons, and only with coupons.</p>
<p>In this chapter we will take a look at the different types of coupons we can
work in Elcodi. Of course, this model can evolve and get better.</p>
<h2 id="create-coupon">Create coupon<a class="headerlink" href="#create-coupon" title="Permanent link"> #</a></h2>
<p>If you want to create a new coupon instance, you should always use the factory
object defined in the dependency injection layer. The service is defined with
the name <code>elcodi.factory.coupon</code> and is available for injection as follows.</p>
<pre><code class="yaml">services:
    my_service:
        class: My\Service\Namespace
        arguments:
            - @elcodi.factory.coupon
</code></pre>

<p>a small snippet of this service could be that one</p>
<pre><code class="php">$coupon = $this
    -&gt;couponFactory
    -&gt;create()
</code></pre>

<p>Please, follow this cookbook if you need more information about elcodi factories.</p>
<ul>
<li><a href="http://elcodi.io/docs/cookbook/implementation/implement-a-factory/">How to implement a factory</a></li>
</ul>
<h2 id="coupon-types">Coupon types<a class="headerlink" href="#coupon-types" title="Permanent link"> #</a></h2>
<blockquote>
<p>Important. This part of the documentation describes how Elcodi manages the
types involving the elcodi's Cart implementation.</p>
</blockquote>
<p>There are several types of application in elcodi Coupons and each of them uses
a certain part of the Coupon entity. The type of the coupon can be defined using
the field <code>$type</code> of Coupon.</p>
<pre><code class="php">use Elcodi\Component\Coupon\Entity\Coupon;

$coupon = new Coupon();
$coupon-&gt;setType($type);
</code></pre>

<p>Let's take a look to each one.</p>
<h3 id="absolute-value-coupons">Absolute value coupons<a class="headerlink" href="#absolute-value-coupons" title="Permanent link"> #</a></h3>
<p>This is the common and default coupon type. You apply an specific discount for
the cart defined by an specific amount, for example 10 euros.</p>
<pre><code class="php">use Elcodi\Component\CartCoupon\Applicator\AbsoluteCartCouponApplicator;

$price = ... // Money instance

$coupon-&gt;setType(AbsoluteCartCouponApplicator::id();
$coupon-&gt;setPrice($price);
</code></pre>

<h3 id="percent-coupons">Percent coupons<a class="headerlink" href="#percent-coupons" title="Permanent link"> #</a></h3>
<p>This coupon introduces a percent discount for the final cart.</p>
<pre><code class="php">use Elcodi\Component\CartCoupon\Applicator\PercentCartCouponApplicator;

$coupon-&gt;setType(PercentCartCouponApplicator::id();
$coupon-&gt;setDiscount(15);
</code></pre>

<h3 id="nxm-coupons">NxM coupons<a class="headerlink" href="#nxm-coupons" title="Permanent link"> #</a></h3>
<p>This coupon is intended to be a <em>"buy n units and pay only m"</em>. Because the
system should always be opened for evolution, the configuration of this coupon
is done by using an specific syntax.</p>
<pre><code class="php">use Elcodi\Component\CartCoupon\Applicator\Abstracts\AbstractMxNCartCouponApplicator;

$coupon-&gt;setType(AbstractMxNCartCouponApplicator::id();
$coupon-&gt;setValue('xxx');
</code></pre>

<p>In this chapter we will explain how to configure these coupons. This
configuration is splitted in three blocks. Each one defines an specific part of
the coupon and they are splitted by the symbol <code>:</code>.</p>
<h4 id="nxm-configuration">NxM Configuration<a class="headerlink" href="#nxm-configuration" title="Permanent link"> #</a></h4>
<p>First block. Configures the NxM definition:</p>
<ul>
<li>N: Units to buy</li>
<li>M: Units to pay</li>
</ul>
<p>For example, 3x2 means pay 2 and buy 3. That simple.</p>
<h4 id="filtering-configuration">Filtering Configuration<a class="headerlink" href="#filtering-configuration" title="Permanent link"> #</a></h4>
<p>The second block aims to be the filter of the coupon. What elements should this
coupon be applied on? You can filter by using product ids, category ids or
manufacturer ids.</p>
<p>Let's see some examples with the explanation of the meaning (all of them start
with Pay 2 and Buy 3):</p>
<ul>
<li><strong>3x2:p(12)</strong> - Only applies to purchasables with id 12</li>
<li><strong>3x2:p(50,2)</strong> - Only applies to purchasables with id 50 or 2</li>
<li><strong>3x2:c(1)</strong> - Only applies to purchasables of category with id 1</li>
<li><strong>3x2:c(1,3)</strong> - Only applies to purchasables of category with id 1 or 3</li>
<li><strong>3x2:m(5)</strong> - Only applies to purchasables of manufacturer with id 5</li>
<li><strong>3x2:m(5,45)</strong> - Only applies to purchasables of manufacturer with id 5 or 45</li>
<li><strong>3x2:c(50)&amp;m(2)</strong> - Only applies to purchasables of category with id 50 and
manufacturer with id 2</li>
<li><strong>3x2:p(10)|m(2)|c(4,10)</strong> - Only applies to purchasables that have id 50, or
with category 4 or 10, or with manufacturer 2.</li>
</ul>
<h4 id="modifiers-configuration">Modifiers Configuration<a class="headerlink" href="#modifiers-configuration" title="Permanent link"> #</a></h4>
<p>Last block. Once you've filtered, you can configure some special behaviors of
your coupon. Each one of the modifiers are a simple letter at the end of the
expression. You can add as many as you need, no matter the order between them.</p>
<p>The first group of modifiers are related to what family of Purchasables this
coupon should apply with.</p>
<ul>
<li>P - Coupon applicable only on Products</li>
<li>V - Coupon applicable only on Variants</li>
<li>K - Coupon applicable only on Packs</li>
</ul>
<p>You can combine them all</p>
<ul>
<li>PK - Coupon applicable only on Products and Packs</li>
</ul>
<p>Lets see an example</p>
<ul>
<li><strong>3x2:c(12):PK</strong> - Pay 2 and buy 3. Applicable only on products and packs that
are from category with id 12.</li>
</ul>
<p>The second group of modifiers are related to how to apply the coupon once all
purchasable elements are selected.</p>
<p>By default, your MxN coupon is applied to each purchasable selected. For
example, if your cart has a product 3 times and a pack 3 times, both available
for a 3x2 coupon, the coupon will be applied for each one in an independent way,
so you will pay 2 products and 2 packs. One of each them will be free.</p>
<ul>
<li>G - Group modificator. This modificator allow you to treat all purchasables as
the same when applying the coupon. With the last example, you would have 6
purchasables, and you would get free only the 2 most cheap (no matter if they
are products or packs).</li>
</ul>
<p><strong>3x2:c(12):PKG</strong></p>
<h3 id="adding-a-new-filter">Adding a new filter<a class="headerlink" href="#adding-a-new-filter" title="Permanent link"> #</a></h3>
<p>You can add a new filter by creating a new implementation of interface
<code>Symfony\Component\ExpressionLanguage\ExpressionLanguage</code>.</p>
<p>This filter uses the ExpressionLanguage that Symfony provides, so make sure you
know how it works.</p>
<p>This interface requires you to implement a method called registerFunction.</p>
<pre><code class="php">/**
 * Interface ExpressionLanguageFunctionInterface.
 */
interface ExpressionLanguageFunctionInterface
{
    /**
     * Register function.
     *
     * @param ExpressionLanguage $expressionLanguage Expression language
     */
    public function registerFunction(ExpressionLanguage $expressionLanguage);
}
</code></pre>

<p>Once you have created this implementation, you need to register it in your
dependency injection file with a tag.</p>
<pre><code class="yml">services:
    elcodi.cart_coupon_applicator_function.custom:
        class: My\Custom\Applicator\Function\Namespace
        public: false
        tags:
            - { name: elcodi.cart_coupon_applicator_function }
</code></pre>

<h3 id="adding-a-new-type">Adding a new Type<a class="headerlink" href="#adding-a-new-type" title="Permanent link"> #</a></h3>
<p>You can add a new Type as well. In that case you must create a new
implementation for interface
<code>Elcodi\Component\CartCoupon\Applicator\Interfaces\CartCouponApplicatorInterface</code>.</p>
<p>This interface requires you to implement these methods.</p>
<pre><code class="php">/**
 * Interface CartCouponApplicatorInterface.
 */
interface CartCouponApplicatorInterface
{
    /**
     * Get the id of the Applicator.
     *
     * @return string Applicator id
     */
    public static function id();

    /**
     * Can be applied.
     *
     * @param CartInterface   $cart   Cart
     * @param CouponInterface $coupon Coupon
     *
     * @return bool Can be applied
     */
    public function canBeApplied(
        CartInterface $cart,
        CouponInterface $coupon
    );

    /**
     * Calculate coupon absolute value.
     *
     * @param CartInterface   $cart   Cart
     * @param CouponInterface $coupon Coupon
     *
     * @return MoneyInterface|false Absolute value for this coupon in this cart.
     */
    public function getCouponAbsoluteValue(
        CartInterface $cart,
        CouponInterface $coupon
    );
}
</code></pre>

<p>Once you have implemented this method, then you need to register your new
service in your dependency injection configuration file.</p>
<pre><code class="yml">services:
    elcodi.cart_coupon_applicator.custom:
        class: My\Custom\Applicator\Namespace
        tags:
            - { name: elcodi.cart_coupon_applicator }
</code></pre>

<h2 id="coupon-enforcement">Coupon enforcement<a class="headerlink" href="#coupon-enforcement" title="Permanent link"> #</a></h2>
<p>Another possible coupon configuration is the enforcement. The real meaning of
that value is for <em>How the coupon is applied</em>. Values can be manually and
automatically.</p>
<pre><code class="php">namespace Elcodi\Component\Coupon;
/**
 * Class ElcodiCouponTypes
 */
final class ElcodiCouponTypes
{
    /**
     * @var integer
     *
     * Automatic enforcement
     */
    const ENFORCEMENT_AUTOMATIC = 1;

    /**
     * @var integer
     *
     * Manual enforcement
     */
    const ENFORCEMENT_MANUAL = 2;
}
</code></pre>

<p>With the first one you are creating a coupon that will be applied automatically
in all carts. This doesn't mean that will be really applied to all of them, but
just tried.</p>
<h2 id="minimum-purchase">Minimum purchase<a class="headerlink" href="#minimum-purchase" title="Permanent link"> #</a></h2>
<p>You can define that a coupon is only applicable when a cart price is above a 
certain price. The way to do that is by using the property called
<code>$minimumPurchase</code>. This property may be an instance of <code>Elcodi\Component\Currency\Entity\Money</code>.</p>
<pre><code class="php">/**
 * Set minimum purchase
 *
 * @param MoneyInterface $amount Absolute Price
 *
 * @return $this Self object
 */
public function setMinimumPurchase(MoneyInterface $amount)
{
    $this-&gt;minimumPurchaseAmount = $amount-&gt;getAmount();
    $this-&gt;minimumPurchaseCurrency = $amount-&gt;getCurrency();
    return $this;
}
/**
 * Get minimum purchase
 *
 * @return MoneyInterface Absolute Price
 */
public function getMinimumPurchase()
{
    return Money::create(
        $this-&gt;minimumPurchaseAmount,
        $this-&gt;minimumPurchaseCurrency
    );
}
</code></pre>

<h2 id="adding-some-rules">Adding some Rules<a class="headerlink" href="#adding-some-rules" title="Permanent link"> #</a></h2>
<p>When a Coupon is intended to be applied in a Cart and the field <code>$rule</code> is not
null, then this rule is applied. Of course, if the rule execution result is
false, the coupon is refused.</p>
<p>you can read some information about rules by following these links</p>
<ul>
<li><a href="http://symfony.com/blog/new-in-symfony-2-4-the-expressionlanguage-component">New in Symfony 2.4: The ExpressionLanguage Component</a></li>
<li><a href="http://symfony.com/doc/current/components/expression_language/index.html">ExpressionLanguage Symfony Component</a></li>
</ul></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
                <p>Copyright © 2014/2015 <a href="http://www.elcodi.io">Elcodi</a>. All rights reserved.</p>
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
