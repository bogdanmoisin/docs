<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://www.elcodi.io/book/payments/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>Payments - Elcodi Documentation</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <link href="../../css/elcodi.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../.."><img src="../../img/elcodi.png" height="30" /></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                
                
                
                    
                        <li >
                            <a href="../../quick-start/">Quick start</a>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown active">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Book <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../cart-architecture/">Cart architecture</a>
</li>

                            
                                
<li >
    <a href="../category-architecture/">Category architecture</a>
</li>

                            
                                
<li >
    <a href="../commands/">Commands</a>
</li>

                            
                                
<li >
    <a href="../coupon-architecture/">Coupon architecture</a>
</li>

                            
                                
<li >
    <a href="../dictionary/">Dictionary</a>
</li>

                            
                                
<li >
    <a href="../emails/">Emails</a>
</li>

                            
                                
<li >
    <a href="../events/">Events</a>
</li>

                            
                                
<li >
    <a href="../features/">Features</a>
</li>

                            
                                
<li >
    <a href="../">Home</a>
</li>

                            
                                
<li class="active">
    <a href="./">Payments</a>
</li>

                            
                                
<li >
    <a href="../philosophy/">Philosophy</a>
</li>

                            
                                
<li >
    <a href="../plugins/">Plugins</a>
</li>

                            
                                
<li >
    <a href="../processes/">Processes</a>
</li>

                            
                                
<li >
    <a href="../product-architecture/">Product architecture</a>
</li>

                            
                                
<li >
    <a href="../pull-requests/">Pull requests</a>
</li>

                            
                                
<li >
    <a href="../roadmap/">Roadmap</a>
</li>

                            
                                
<li >
    <a href="../running-test-suite/">Running test suite</a>
</li>

                            
                                
<li >
    <a href="../shipping/">Shipping</a>
</li>

                            
                                
<li >
    <a href="../standards/">Standards</a>
</li>

                            
                                
<li >
    <a href="../templates/">Templates</a>
</li>

                            
                                
<li >
    <a href="../translate-elcodi/">Translate elcodi</a>
</li>

                            
                                
<li >
    <a href="../vagrant-quick-start/">Vagrant quick start</a>
</li>

                            
                                
<li >
    <a href="../what-is-elcodi/">What is elcodi</a>
</li>

                            
                                
<li >
    <a href="../why-elcodi/">Why elcodi</a>
</li>

                            
                            </ul>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../cookbook/">Home</a>
</li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Installation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/installation/install-a-plugin/">Install a plugin</a>
</li>

        
            
<li >
    <a href="../../cookbook/installation/install-dependent-bundles/">Install dependent bundles</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Overwrite</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-a-parameter/">Overwrite a parameter</a>
</li>

        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-a-service/">Overwrite a service</a>
</li>

        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-an-entity/">Overwrite an entity</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Deprecation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/deprecation/deprecate-a-method/">Deprecate a method</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Adapters</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/adapters/currency-rates-populator/">Currency rates populator</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/image-resize/">Image resize</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/location-loader/">Location loader</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/location-populator/">Location populator</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/location-provider/">Location provider</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/metric-bucket/">Metric bucket</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/related-purchasables-provider/">Related purchasables provider</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Workflow</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/workflow/create-automatic-coupon/">Create automatic coupon</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Usage</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/usage/elcodi-watermark/">Elcodi watermark</a>
</li>

        
            
<li >
    <a href="../../cookbook/usage/referrer-domain/">Referrer domain</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Implementation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/implementation/implement-a-collector/">Implement a collector</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-controller-and-a-command/">Implement a controller and a command</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-factory/">Implement a factory</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-form-type/">Implement a form type</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-repository/">Implement a repository</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-an-entity/">Implement an entity</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-an-event-listener/">Implement an event listener</a>
</li>

        
    </ul>
  </li>

                            
                            </ul>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Component <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../component/entity-translator/">Entity translator</a>
</li>

                            
                                
<li >
    <a href="../../component/">Home</a>
</li>

                            
                                
<li >
    <a href="../../component/media/">Media</a>
</li>

                            
                                
<li >
    <a href="../../component/menu/">Menu</a>
</li>

                            
                                
<li >
    <a href="../../component/metrics/">Metrics</a>
</li>

                            
                                
<li >
    <a href="../../component/sitemap/">Sitemap</a>
</li>

                            
                                
<li >
    <a href="../../component/state-transition-machine/">State transition machine</a>
</li>

                            
                                
<li >
    <a href="../../component/template/">Template</a>
</li>

                            
                            </ul>
                        </li>
                    
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../philosophy/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/elcodi/docs">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#payments">Payments</a></li>
        
            <li><a href="#requirements">Requirements</a></li>
        
            <li><a href="#example">Example</a></li>
        
            <li><a href="#calling-for-shipping-methods">Calling for Shipping methods</a></li>
        
            <li><a href="#adding-new-payment-method">Adding new Payment Method</a></li>
        
            <li><a href="#payment-scripts">Payment scripts</a></li>
        
            <li><a href="#accessing-collected-methods">Accessing collected methods</a></li>
        
            <li><a href="#payment">Payment</a></li>
        
            <li><a href="#payment-state-machine">Payment State Machine</a></li>
        
            <li><a href="#updating-the-payment-state">Updating the Payment state</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="payments">Payments<a class="headerlink" href="#payments" title="Permanent link"> #</a></h1>
<p>All e-commerce, for sure, need to have a payment platform for completing the
shopping workflow successfully.</p>
<p>For this integration or implementation, all kind of projects are used to working
with external PHP libraries, so in our case we are not going to be different at
all (and because we believe in third party projects as well). In this example we
will work using a simple and free payment example, so the real meaning of these
lines is showing you how to build your own payment library.</p>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link"> #</a></h2>
<p>This chapter is a little bit complex, so let's focus on some interesting topics
related with Payments and this implementation. Some extra information will be
enough to have a base before starting this read.</p>
<ul>
<li><a href="http://elcodi.io/docs/book/plugins/">Plugins</a></li>
<li><a href="http://symfony.com/doc/current/components/dependency_injection/introduction.html">Dependency Injection Symfony Component</a></li>
<li><a href="http://symfony.com/doc/current/components/event_dispatcher/introduction.html">Event Dispatcher Symfony Component</a></li>
<li><a href="http://github.com/paymentsuite">PaymentSuite Payment PHP Library</a></li>
<li><a href="http://github.com/Payum">Payum Payment PHP</a></li>
</ul>
<h2 id="example">Example<a class="headerlink" href="#example" title="Permanent link"> #</a></h2>
<p>Let's figure out that we want to add a new free payment module. This payment
method will have a reference name called <code>free_payment</code>, and even is not
important at all what's the name, we will use it to detect how we should use the
name, whatever it is, in our services and bundle implementation.</p>
<p>Our payment method will be always available.</p>
<h2 id="calling-for-shipping-methods">Calling for Shipping methods<a class="headerlink" href="#calling-for-shipping-methods" title="Permanent link"> #</a></h2>
<p>Imagine that your cart is already completed and finished. Then it's time to pay
it. Elcodi platform only provides you one single and easy way of collecting all
these methods.</p>
<p>It is important to understand that Elcodi will never consider throwing any kind
of event related to any specific payment method neither any order paid related
one, so each integration should have their own events for that.</p>
<p>In other words, Elcodi only will provide a simple point of entry to the payment
engine.</p>
<p>At the point we need to  want to collect all payment methods, we are going to
use the service created specifically for that.</p>
<pre><code class="php">$paymentMethods = $this
    -&gt;get('elcodi.wrapper.payment_methods')
    -&gt;get($cart);
</code></pre>

<p>Internally, this piece of code dispatches an event called 
<em><a href="http://elcodi.io/docs/book/events/#payment.collect">"payment.collect"</a></em>, responsible exclusively for
collecting all these payment methods.</p>
<p>It is necessary to say that at this point, the Event Dispatcher component is not
working in a very strict way it should work, so it's being used as a collector
manager instead of an event dispatcher. The difference between both is that an
event should be inmutable (an event just happends, and there's no much to be
done then... just add some reactions using event listeners), but in that case,
the object Event has a <code>hasXXX</code> method, so, even not being imortant the order
of the listeners execution, the event is being modified on the fly. A changer
event... weird, right?</p>
<ul>
<li><a href="http://elcodi.io/docs/cookbook/implementation/implement-a-collector/">Implement a collector</a></li>
</ul>
<p>Anyway, the recollection event is dispatched and all installed and initialized
Plugins (in Kernel) are called to add some payment methods there.</p>
<h2 id="adding-new-payment-method">Adding new Payment Method<a class="headerlink" href="#adding-new-payment-method" title="Permanent link"> #</a></h2>
<p>For you, developer, that you want to add a payment method, that's your chapter.
Remember the event <em><a href="http://elcodi.io/docs/book/events/#shipping.collect">"shipping.collect"</a></em>? Well, we
must listen it in order to add new payment methods.</p>
<p>Since now, none object is passed though the event in order to decide if a
payment method is available or not, so only the plugin statement should be
checked.</p>
<p>Let's take a look firstly how can we subscribe to this event using the same
methodology of subscribing any event.</p>
<pre><code class="yml">services:

    #
    # Event Listeners
    #
    elcodi_plugin.free_payment.event_listener.payment_collect:
        class: Elcodi\Plugin\FreePayment\EventListener\PaymentCollectEventListener
        tags:
            - { name: kernel.event_listener, event: payment.collect, method: addCustomPaymentMethods }
</code></pre>

<p>Great. In this Event Listener we should add all our business logic (of course,
is much better to place all your business logic inside a service, but it depends
on your strategy). We'll doing like this in this example. Let's take a look.</p>
<pre><code class="php">use Elcodi\Component\Currency\Entity\Money;
use Elcodi\Component\Payment\Entity\PaymentMethod;
use Elcodi\Component\Payment\Event\PaymentCollectionEvent;

/**
 * Class PaymentCollectEventListener
 */
class PaymentCollectEventListener
{
    /**
     * Look for available payment methods
     *
     * @param PaymentCollectionEvent $event Event
     *
     * @return $this Self object
     */
    public function addCustomPaymentMethods(PaymentCollectionEvent $event)
    {
        $event
            -&gt;addPaymentMethod(new PaymentMethod(
                'free-payment',
                'Your order for free!',
                'You can buy whatever you want for free!',
                'http://my-free-payment.com',
                'http://my-free-payment.com/logo.png,
                '&lt;script&gt;&lt;/script&gt;'
            ));
    }
}
</code></pre>

<p>As you can see, when we create a new instance of the object <code>PaymentMethod</code> you
can add some properties like <code>url</code>, <code>imageUrl</code> and <code>script</code>.</p>
<pre><code class="php">namespace Elcodi\Component\Payment\Entity;

/**
 * Class PaymentMethod
 */
class PaymentMethod
{
    /**
     * Construct
     *
     * @param string $id          Id
     * @param string $name        Name
     * @param string $description Description
     * @param string $url         Url
     * @param string $imageUrl    Image url
     * @param string $script      Script
     */
    public function __construct(
        $id,
        $name,
        $description,
        $url,
        $imageUrl = '',
        $script = ''
    ) {
        $this-&gt;id = $id;
        $this-&gt;name = $name;
        $this-&gt;description = $description;
        $this-&gt;url = $url;
        $this-&gt;imageUrl = $imageUrl;
        $this-&gt;script = $script;
    }
}
</code></pre>

<p>This is because, in most cases, a payment platform, or in all middleware
integrations, we are used to working with one of these scenarios:</p>
<ul>
<li>The platform proposes us an external url with an associated image. It is
common to see this when our user must jump to another domain for the payment
action. In that case, we should use both <code>url</code> and <code>imageUrl</code>.</li>
<li>The platform provides us an script with HTML and some JS. This is used for
internal payment with some callable urls managed by the script itself. In that
case you should use <code>script</code> and <code>imageUrl</code>.</li>
</ul>
<h2 id="payment-scripts">Payment scripts<a class="headerlink" href="#payment-scripts" title="Permanent link"> #</a></h2>
<p>To work with platforms that require some HTML or JS to be used, then it is
common and healthy to use Twig templating, instead of PHP variables.</p>
<p>Let's see a little bit more complex example of how to use speciic scripts and
the router for the creation of routes.</p>
<pre><code class="php">use Symfony\Bundle\FrameworkBundle\Templating\EngineInterface;
use Symfony\Component\Form\FormFactory;
use Symfony\Component\Routing\Generator\UrlGeneratorInterface;

use Elcodi\Component\Currency\Entity\Money;
use Elcodi\Component\Payment\Entity\PaymentMethod;
use Elcodi\Component\Payment\Event\PaymentCollectionEvent;

/**
 * Class PaymentCollectEventListener
 */
class PaymentCollectEventListener
{   
    /**
     * @var EngineInterface
     *
     * Twig engine
     */
    protected $templating;

    /**
     * @var FormFactory
     *
     * Form factory
     */
    protected $formFactory;

    /**
     * @var UrlGeneratorInterface
     *
     * Router
     */
    protected $router;

    /**
     * Construct
     *
     * @param EngineInterface $templating         Twig engine
     * @param FormFactory     $formFactory        Form factory
     * @param UrlGeneratorInterface $urlGenerator Url generator
     */
    public function __construct(
        EngineInterface $templating,
        FormFactory $formFactory,
        UrlGeneratorInterface $urlGenerator
    ) {
        $this-&gt;templating = $templating;
        $this-&gt;formFactory = $formFactory;
        $this-&gt;urlGenerator = $urlGenerator;
    }

    /**
     * Look for available payment methods
     *
     * @param PaymentCollectionEvent $event Event
     *
     * @return $this Self object
     */
    public function addCustomPaymentMethods(PaymentCollectionEvent $event)
    {
        /**
         * If we need to create a new url
         */
        $url = $this
            -&gt;urlGenerator
            -&gt;generate('free_payment_url);

        /**
         * If we need to inject a custom view with a custom form view, then
         * you must create both elements like is shown here
         */
        $form = $this
            -&gt;formFactory
            -&gt;create('free_payment_form_type')
            -&gt;createView();

        $view = $this
            -&gt;templating
            -&gt;render('FreePaymentBundle:Payment:view.html.twig', [
                'form' =&gt; $form,
            ]);

        $event
            -&gt;addPaymentMethod(new PaymentMethod(
                'free-payment',
                'Your order for free!',
                'You can buy whatever you want for free!',
                $url,
                'http://my-free-payment.com/logo.png,
                $view
            ));
    }
}
</code></pre>

<p>And the Dependency Injection definition would be like this</p>
<pre><code class="yml">services:

    #
    # Event Listeners
    #
    elcodi_plugin.free_payment.event_listener.payment_collect:
        class: Elcodi\Plugin\FreePayment\EventListener\PaymentCollectEventListener
        arguments:
            - @templating
            - @form.factory
            - @router
        tags:
            - { name: kernel.event_listener, event: payment.collect, method: addCustomPaymentMethods }
</code></pre>

<h2 id="accessing-collected-methods">Accessing collected methods<a class="headerlink" href="#accessing-collected-methods" title="Permanent link"> #</a></h2>
<p>Once we have added all our payment methods, then we should be able to access all
the information in order to be able to offer all payment methods to the final
user.</p>
<p>This is a piece of code of our template.</p>
<pre><code class="jinja">&lt;div class=&quot;form-checkout&quot;&gt;
    {% for paymentMethod in paymentMethods %}
        {% set paymentMethodName = paymentMethod.name %}
        {% if paymentMethod.url %}
                &lt;h2&gt;{{ paymentMethodName|trans }}&lt;/h2&gt;
                &lt;p&gt;&lt;a href=&quot;{{ paymentMethod.url }}&quot; class=&quot;button button-secondary&quot;&gt;{{ 'template.store_template_bundle.checkout.payment.continue'|trans }}&lt;/a&gt;&lt;/p&gt;
                &lt;hr /&gt;
        {% else %}
            &lt;details class=&quot;test-payment-{{ paymentMethod.id }} form form-{{ paymentMethodName|trans|lower }}&quot;&gt;
                &lt;summary&gt;{{ paymentMethodName|trans }}&lt;/summary&gt;
                &lt;div class=&quot;payment-wrapper&quot;&gt;
                    {{ paymentMethod.script|raw }}
                &lt;/div&gt;
            &lt;/details&gt;
        {% endif %}

    {% endfor %}
&lt;/div&gt;
</code></pre>

<p>As you can see in both cases (with and without script), each element of the
array named <code>paymentMethods</code> is a payment method instance inserted by each
Payment integration plugin previously.</p>
<p>Another way to access the payment methods directly from the templating layer is
using the Twig function.</p>
<pre><code class="jinja">{% set paymentMethods = elcodi_payment_methods() %}
</code></pre>

<h2 id="payment">Payment<a class="headerlink" href="#payment" title="Permanent link"> #</a></h2>
<p>As said before, each platform should take care about the payment process. Of 
course, only one strict action must be done in this process, and this is the
transformation of the cart to a valid order.</p>
<p>This action is not responsibility of the payment platform at all, but it should
dispatch the change by using one available service.</p>
<pre><code class="php">$cart = $this
    -&gt;cartWrapper
    -&gt;get();

$order = $this
    -&gt;container
    -&gt;get('elcodi.transformer.cart_order')
    -&gt;createOrderFromCart($cart);
</code></pre>

<h2 id="payment-state-machine">Payment State Machine<a class="headerlink" href="#payment-state-machine" title="Permanent link"> #</a></h2>
<p>At this point, the order is ready to be shipped. Once starting these last steps
on this documentation, please take a look at the State Transition Machine 
documentation.</p>
<ul>
<li><a href="http://elcodi.io/docs/component/state-transition-machine/">State Transition Machine</a></li>
</ul>
<p>Bamboo. by default, proposes a payment state diagram like we can see here.</p>
<table>
<thead>
<tr>
<th>From</th>
<th>Action</th>
<th>To</th>
</tr>
</thead>
<tbody>
<tr>
<td>unpaid</td>
<td>pay</td>
<td>paid</td>
</tr>
<tr>
<td>paid</td>
<td>refund</td>
<td>refunded</td>
</tr>
</tbody>
</table>
<p>and through the Symfony Container we have access to some specific objects of the
Payment State Machine.</p>
<pre><code class="yaml">#
# Order state machine for Shipping
#
elcodi.order_payment_states_machine_builder:
    class: Elcodi\Component\StateTransitionMachine\Machine\MachineBuilder
    arguments:
        - @elcodi.factory.state_transition_machine
        - %elcodi.order_payment_states_machine_identifier%
        - %elcodi.order_payment_states_machine_states%
        - %elcodi.order_payment_states_machine_point_of_entry%

elcodi.order.payment_states_machine:
    class: Elcodi\Component\StateTransitionMachine\Machine\Machine
    factory:
        - @elcodi.order_payment_states_machine_builder
        - compile

elcodi.order_payment_states_machine_manager:
    class: Elcodi\Component\StateTransitionMachine\Machine\MachineManager
    arguments:
        - @elcodi.order.payment_states_machine
        - @event_dispatcher
        - @elcodi.factory.state_transition_machine_state_line
</code></pre>

<h2 id="updating-the-payment-state">Updating the Payment state<a class="headerlink" href="#updating-the-payment-state" title="Permanent link"> #</a></h2>
<p>With this access to the Payment State Machine, we can change the state of an
Order by using the service <code>elcodi.order_payment_states_machine</code>.</p>
<p>Let's see an example of how to go to the state called <code>paid</code>, taking in account
that our actual state is called <code>unpaid</code>.</p>
<pre><code class="php">$order = // Order instance;

$stateLineStack = $this
    -&gt;get('elcodi.order_payment_states_machine_manager')
    -&gt;transition(
        $order,
        $order-&gt;getPaymentStateLineStack(),
        'paid',
        'Order paid by credit cart'
    );

$order-&gt;setPaymentStateLineStack($stateLineStack);
$this
    -&gt;get('elcodi.object_manager.order')
    -&gt;flush($order);
</code></pre>

<p>Only if given transition is possible all is going to work properly. Otherwise
some Exceptions will be thrown.</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
                <p>Copyright © 2014/2015 <a href="http://www.elcodi.io">Elcodi</a>. All rights reserved.</p>
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
